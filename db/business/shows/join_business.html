<!-- 
Begin db/business/shows/join_business.html
 -->
<div class = "content">

    <div id = "business_summary">

        <h2 id="_id">{{ _id }}</h2>

        <h4 id="author">Created by <a href="/business/{{bid}}/member/{{author}}">{{ author }}</a></h3>

        <h4 id="list_of_partners">Partners: 
                {{#list_of_partners}}
                    <a href="/business/{{bid}}/member/{{value}}">{{value}}</a>,&nbsp
                {{/list_of_partners}}
        </h4>

        <h4 id="description">{{ description }}</h4> 

    </div>

    <div id = "member_info">

        <p>Your initial information is summarized below:</p>

        <form id="member_form" onsubmit="return false;" action="/api/business/{{bid}}/member/{{_id}}">
		    <fieldset class="member_info">
			    <legend>Member Information</legend>
				    <ul>
                        <li><label for="role">Role</label><input type="text" name="role" id="role" value = "worker" readonly/></li>
                        <li><label for="network">Network</label><input type="text" name="network" id="network" value = "Facebook" readonly/></li>
                        <li><label for="type">Type</label><input type="text" name="type" id="type" value = "person" readonly/></li>
                   	</ul>
		    </fieldset>

            <fieldset class="member_skills">
			    <legend>Member Skills</legend>
				    <ul>
                    {{#activity_skills}}
                    <li>
                        <label for="{{value}}">{{value}}</label>
                        <input type="checkbox" name="skills" id="{{value}}" value = "{{value}}" />
                    </li>
                    {{/activity_skills}}
                    </ul>
            </fieldset>
        </form>
    </div>

    <button id="join_business">Join {{_id}}</button>
 
<script type="text/javascript">

        $(document).ready(function() {
            $("#join_business").click(function(){
                
                var skills = $("input[name='skills']").serializeArray(); 
                var member = Object();
                var form;

                if (skills.length == 0){
                    warn("You must check at least on of the Member Skills listed below!");
                    return;
                } else if (get_user() == null){
                    warn("You must be logged in to facebook to join a business!");
                    return;
                } else {
                    form = $("#member_form").serializeArray();
                    $.each(form, function (item) {
                        member[form[item].name] = form[item].value;
                    });

                    member.skills = [];
                    member.looking_for_work="yes";
                    var d = new Date();
                    member.working_since= d.getTime()/1000;  // db stores seconds
                    $.each(skills, function (item) {
                        member.skills.push(skills[item].value);
                    });

                    /*  The code below is confusing and should be clarified.
                    Essentially to add a person to a busines, their record in socialfarm db must be updated
                    and they must be added as a member to the business database they are joining.
                    the first part is don via the get call at the bottom which retrieves the person object from
                    socialfarm and adds the business to the list of businesses for this person,
                    the success call back is then used to add the member object created from the form (and code above)
                    to the business database
                    */

                    var bid = $('#_id').text() ;
                    var url;
                    var data,loc;
                    //update person in business (bid) db
                    person_url = "/api/person/" + get_user().id ;
                    //TODO:: The below part can be moved to customized scripts
                    if ("{{bid}}" == "social_ride")
                    {
                        if (navigator.geolocation)
                        {
                            navigator.geolocation.getCurrentPosition(getPosition);
                        }
                        else{console.log("Geolocation is not supported by this browser.");}
                        function getPosition(position)
                        {
                            loc = encodePosition(position);
                        }
                    }

						
                    var update_person = function(person){

                        //LOG('revision_cache[url] : ' + revision_cache[person_url]);

                        //LOG('person : ' + person);
                        if ($.inArray(bid, person.businesses) == -1){
                            person.businesses.push(bid);
                            put_json(person_url, JSON.stringify(person), do_nothing);
                        }
                    }

                    get_json(person_url, update_person, do_nothing);
	                temp_url="/socialfarm/"+bid;
                    var add_info = Object();
                    var temp = function( ret )
                    {
                        for(var i=0 ; i < ret['additional_info'].length ; i++ )
                        {
						var key = ret['additional_info'][i];
						if(key == "location")
						{
							    add_info[key] = loc;
					    }
                        else
                            add_info[key] = "";
                        }
                        member.additional_info = add_info;
                        data = JSON.stringify(member) ;
                    }
                    get_json(temp_url,temp,do_nothing);

                    //update person in business (bid) db
                    url =  "/api/business/" + bid + "/object/" + get_user().id
                    
                    data = JSON.stringify(member) ;
                    var join_success = function(){
                        //alert("Congratulations ! You are now part of {{bid}}");
                        //window.location="/business/{{bid}}/member/" + get_user().id ;
                    }
                    var join_failure = function(){
                        alert("Sorry, your request to join {{bid}} is not successful");
                    }
                    var failure = function(){
                        put_json(url, data, join_success, join_failure) ;
                    }
                    var success = function(){
                        LOG('Already a member!');
                        warn("You are already a member of this business!");
                    }
                    get_json(url, success, failure);
                 } 
            });
        });
    </script>
</div> 
<!-- 
End db/business/shows/join_business.html
 -->
</div> 
<!-- 
End db/business/shows/join_business.html
 -->
