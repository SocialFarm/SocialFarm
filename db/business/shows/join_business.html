
<div class = "content">

    <div id = "business_summary">

        <h2 id="_id">{{ _id }}</h2>

        <h4 id="author">Created by <a href="/business/{{bid}}/member/{{author}}">{{ author }}</a></h3>

        <h4 id="list_of_partners">Partners: 
                {{#list_of_partners}}
                    <a href="/business/{{bid}}/member/{{value}}">{{value}}</a>,&nbsp
                {{/list_of_partners}}
        </h4>

        <h4 id="description">{{ description }}</h4> 

    </div>

    <div id = "member_info">

        <p>Your initial information is summarized below:</p>

        <form id="member_form" onsubmit="return false;" action="/api/business/{{bid}}/member/{{_id}}">
		    <fieldset class="member_info">
			    <legend>Member Information</legend>
				    <ul>
                        <li><label for="role">Role</label><input type="text" name="role" id="role" value = "worker" readonly/></li>
                        <li><label for="network">Network</label><input type="text" name="network" id="network" value = "Facebook" readonly/></li>
                        <li><label for="type">Type</label><input type="text" name="type" id="type" value = "person" readonly/></li>
                    </ul>
		    </fieldset>

            <fieldset class="member_skills">
			    <legend>Member Skills</legend>
				    <ul>
                    {{#activity_skills}}
                    <li>
                        <label for="{{value}}">{{value}}</label>
                        <input type="checkbox" name="skills" id="{{value}}" value = "{{value}}" />
                    </li>
                    {{/activity_skills}}
                    </ul>
            </fieldset>
        </form>
    </div>

    <button id="join_business">Join {{_id}}</button>
 
    <script type="text/javascript">
    $(document).ready(function() {
        $("#join_business").click(function(){
            join_business();
        });
    });

    function AfterFacebookIsLoaded() {
        render_member_info();
    }
    
    function render_member_info(){
        var html = '';
        if (get_user() != null){
            html =  '<li><label for="_id">Member ID</label><input type="text" name="_id" id="_id" value = "' + get_user().id + '"readonly/></li>' +
                    '<li><label for="name">Name</label><input type="text" name="name" id="name" value = "' + get_user().name + '"readonly/></li>';
            $('#member_info ul').prepend(html);
        }
    }
    
    function join_business(){
        var skills = $("input[name='skills']").serializeArray(); 
        var member = Object();
        var form;

        if (skills.length == 0){
            warn("You must check at least on of the Member Skills listed below!");
            return;
        } else if (get_user() == null){
            warn("You must be logged in to facebook to join a business!");
            return;
        } else {
            form = $("#member_form").serializeArray();
            $.each(form, function (item) {
                member[form[item].name] = form[item].value;
            });

            member.skills = [];

            $.each(skills, function (item) {
                member.skills.push(skills[item].value);
            });
      
            /*  The code below is confusing and should be clarified.
            Essentially to add a person to a busines, their record in socialfarm db must be updated
            and they must be added as a member to the business database they are joining.
            the first part is don via the get call at the bottom which retrieves the person object from
            socialfarm and adds the business to the list of businesses for this person,
            the success call back is then used to add the member object created from the form (and code above)
            to the business database
            */

            var bid = $('#_id').text() ;
            var url = "/api/person/" + get_user().id ;
            var data;

            var success = function(person) {
            person.businesses.push(bid);
            data = JSON.stringify(person) ;
            //update person in business (bid) db
            put_json(url, data, do_nothing, do_nothing) ;
            url =  "/api/business/" + bid + "/object/" + get_user().id
            data = JSON.stringify(member) ;
            //update person in business (bid) db
            put_json(url, data, do_nothing, do_nothing) ;
            };
            get_json(url, success, do_nothing); 
         } 
    }
    </script>
</div> 

